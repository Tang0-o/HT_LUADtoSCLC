---
title: "Fig2_step2_27regulons_gsva_NTbulk_human"
author: "tang"
date: "2025-07-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = here::here())
```

1 加载所需要的R包，设置文件目录
```{r}
Sys.setenv(LANGUAGE = "en")
library(GSVA)
library(GSEABase)
library(limma)
library(data.table)
library(dplyr)
library(tidyr)
library(ggpubr)
library(ggsci)

source('/home/data/tmh_project/SCLC/source_global/write_read_gmt.R')

output_1 <- '2_27regulon_gsva'
dir.create(output_1)
Rscripts_dir <- '/home/data/tmh_project/SCLC/Fig2_NTbulk_human/Rscripts'
```

2 读取临床信息文件
```{r}
#读取不同分组的表达矩阵
# exp_22 <- read.csv("1_NTbulkdata_E-MTAB-10399/GeneFPKM_new_22NTsamples.csv", row.names = 1,header=T,sep = ",", quote = "\"")

#读取不同分组的临床信息
cluster_22 <- read.csv('1_NTbulkdata_E-MTAB-10399/metadata_NT_22samples_sorted.csv',row.names = 1, header=T,sep = ",", quote = "\"")
cluster_48 <- read.csv('1_NTbulkdata_E-MTAB-10399/metadata_all_48samples.csv',row.names = 1, header=T,sep = ",", quote = "\"")

```

3 将48个样本的临床信息按照下述样本顺序重新排列并保存
```{r}
# 定义自定义排序
cluster_48$group <- factor(cluster_48$group, 
                           levels = c("C_LUAD", "T_LUAD", "T_SCLC", "C_SCLC"))

# 按新的顺序重新排序
cluster_48 <- cluster_48[order(cluster_48$group), ]
write.csv(cluster_48,file = '1_NTbulkdata_E-MTAB-10399/metadata_all_48samples_sorted.csv')
```

4 运行将上述27个regulon list运行gsva
```{r}
source(file.path(Rscripts_dir,'4_run_gsva_analysis.R'))
geneset_file <- "/home/data/tmh_project/SCLC/Fig1_sc_mousemodel/after_scenic/regulon27_human_v1.gmt"

# 批量分析多个数据集
datasets <- list(
  exp_22 = "1_NTbulkdata_E-MTAB-10399/GeneFPKM_new_22NTsamples.csv",
  exp_48 = "1_NTbulkdata_E-MTAB-10399/GeneFPKM_new.csv",
  exp_LUAD = "1_NTbulkdata_E-MTAB-10399/GeneFPKM_new_21LUADsamples.csv"
)

results <- list()
for(name in names(datasets)) {
  cat("\n处理数据集:", name, "\n")
  results[[name]] <- run_gsva_analysis(
    exp_file = datasets[[name]],
    geneset_file = geneset_file,
    output_prefix = file.path(output_1,name),
    verbose = TRUE
  )
}

```

5 对48个样本的gsva结果进行可视化
5.1 信息匹配检查
```{r}
gene_regulon_48=t(results$exp_48$ssgsea_result)
#cbind不是按照行名进行合并的，默认两个数据表格的顺序完全一致，直接合并。要检查行名的顺序，还需match
# 确保exp_48与cluster_48的行名顺序一致，以cluster_48的行名顺序为主，调整过顺序，使分组对比看更清晰
matched_gene_regulon_48 <- gene_regulon_48[match(rownames(cluster_48), rownames(gene_regulon_48)), ]
# 检查排序是否正确
if (all(rownames(matched_gene_regulon_48) == rownames(cluster_48))) {
  # 合并数据框
  data_regulon_48 <- cbind(matched_gene_regulon_48, cluster_48)
} else {
  stop("行名排序不一致，请检查数据框的行名")
}
```

5.2 绘制箱线图
```{r}
# 绘制普通的箱线图
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggsci)
library(ggpubr)

data <- as.data.frame(data_regulon_48)
# 将前64列的数据从宽格式转换为长格式
data_long <- data %>%
  pivot_longer(cols = 1:27, names_to = "Type", values_to = "Expression") %>%
  select(Type, Expression, group) %>%
  mutate(Type = factor(Type, levels = colnames(data)[1:27]),
         group = factor(group, levels = c("C_LUAD", "T_LUAD", "T_SCLC", "C_SCLC")))

#comparisons只对比最关注的三个组间差异
comparisons_1 <- list(
  c("C_LUAD", "T_LUAD"),
  c("C_SCLC", "T_SCLC"),
  c("T_LUAD", "T_SCLC")
)

comparisons_2 <- list(
  c("C_LUAD", "T_LUAD"),
  c("C_LUAD", "T_SCLC"),
  c("C_LUAD", "C_SCLC"),
  c("C_SCLC", "T_SCLC"),
  c("T_LUAD", "T_SCLC")
)

g1 <- ggplot(data_long, aes(x = group, y = Expression, fill = group)) +
  geom_boxplot(outlier.colour = "transparent", alpha = 0.7) +
  facet_wrap(~ Type, scales = 'free_y', ncol = 9) +
  scale_fill_manual(values = c("C_LUAD" = "#ADB6CA", "T_LUAD" = "#FDAF91", 
                               "C_SCLC" = "#00468B", "T_SCLC" = "#ED0000")) +
  scale_color_manual(values = c("C_LUAD" = "#ADB6CA", "T_LUAD" = "#FDAF91", 
                               "C_SCLC" = "#00468B", "T_SCLC" = "#ED0000")) +
  theme_classic(base_size = 14) +
  xlab('Group') +
  ylab('Expression') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 12), face = "bold") +
  stat_compare_means(comparisons = comparisons_1, 
                     method = "t.test", label = "p.signif", hide.ns = TRUE, vjust = 0.6)

ggsave(file.path(output_1,'geom_boxplot_v1_gsva_48samples_27regulons.pdf'), g1, width = 21, height = 7)

g2 <- ggplot(data_long, aes(x = group, y = Expression, fill = group)) +
  geom_boxplot(outlier.colour = "transparent", alpha = 0.7) +
  facet_wrap(~ Type, scales = 'free_y', ncol = 9) +
  scale_fill_manual(values = c("C_LUAD" = "#ADB6CA", "T_LUAD" = "#FDAF91", 
                               "C_SCLC" = "#00468B", "T_SCLC" = "#ED0000")) +
  scale_color_manual(values = c("C_LUAD" = "#ADB6CA", "T_LUAD" = "#FDAF91", 
                               "C_SCLC" = "#00468B", "T_SCLC" = "#ED0000")) +
  theme_classic(base_size = 14) +
  xlab('Group') +
  ylab('Expression') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 12), face = "bold") +
  stat_compare_means(comparisons = comparisons_2, 
                     method = "t.test", label = "p.signif", hide.ns = TRUE, vjust = 0.6)

ggsave(file.path(output_1,'geom_boxplot_v2_gsva_48samples_27regulons.pdf'), g2, width = 21, height =7)
```
**5.3 基于以上组间差异检验结果，最终筛选出以下13个转化相关regulon。重点筛选C_LUAD与T_LUAD间有统计学差异的regulon**
转化升高（8个）：
"E2F8 (+)", "FOXM1 (+)","HDAC2(+)",  "MYBL2(+)", "NFYB (+)", "PHF20(+)", "PKNOX1(+)", "TFDP1(+)"
转化降低(5个）：
"ELF1(+)", "ELF5(+)", "ETV1(+)", "MAFB (+)", "ZNF467 (+)"

5.4 过滤，得到13个regulon的list文件。保存在/home/data/tmh_project/SCLC/Fig2_NTbulk_human目录中
```{r}
regulon.list <- read_gmt_file("/home/data/tmh_project/SCLC/Fig1_sc_mousemodel/after_scenic/regulon27_human_v1.gmt")

filtered2 <- c("E2F8(+)", "FOXM1(+)","HDAC2(+)",  "MYBL2(+)", "NFYB(+)", "PHF20(+)", "PKNOX1(+)", "TFDP1(+)",
               "ELF1(+)", "ELF5(+)", "ETV1(+)", "MAFB(+)", "ZNF467(+)")
regulon_13 <- regulon.list[filtered2]

# 验证结果
str(regulon_13)
print(names(regulon_13))
cat("Number of regulons:", length(regulon_13))

write_gmt(regulon_13,filename = '/home/data/tmh_project/SCLC/Fig2_NTbulk_human/regulon13_human_v1.gmt')
```

6 绘制过滤后的27个regulon的不同分组的热图
```{r}
library(pheatmap)
library(RColorBrewer)
library(ggsci)
library(dplyr)
library(ggplot2)
library(reshape2)
library(viridis)
library(cowplot)
library(gridExtra)

# 只保留group、Sample、sex列作为注释信息
Type_regulon <- data_regulon_48[, c("group", "Sample", "sex")]

# 按照箱线图设置的顺序 - 取前27列作为regulon数据
data_48 <- t(data_regulon_48[, 1:27])

# 设置因子顺序 - 按照箱线图的设置
group_order <- c("C_LUAD", "T_LUAD", "T_SCLC", "C_SCLC")
regulon_order <- colnames(data_regulon_48)[1:27]  # 按照原始数据列顺序

# 设置因子
Type_regulon$group <- factor(Type_regulon$group, levels = group_order)

# 按照group顺序排序Type_regulon
Type_regulon <- Type_regulon %>%
  arrange(group)

# 设置regulon（行）的顺序 - 按照指定顺序
data_48 <- data_48[regulon_order, ]

# 同时调整data_48的列顺序与Type_regulon的行顺序一致
data_48 <- data_48[, rownames(Type_regulon)]

# 根据排序后的group分组计算分隔线位置
group_counts <- table(Type_regulon$group)
cumulative_counts <- cumsum(group_counts)
gaps_positions <- cumulative_counts[-length(cumulative_counts)]  # 除了最后一个

print("排序后分组计数:")
print(group_counts)
print("分隔线位置:")
print(gaps_positions)

# 根据实际数据值设置颜色
group_colors <- c("C_LUAD" = "#ADB6CA", "T_LUAD" = "#FDAF91", 
                  "C_SCLC" = "#00468B", "T_SCLC" = "#ED0000")

# 性别颜色设置 - 使用lancet配色
sex_colors <- c("male" = "#42A5F5", "female" = "#FFA726")

# Sample颜色设置 - 为每个样本生成不同颜色
unique_samples <- unique(Type_regulon$Sample)
sample_colors <- rainbow(length(unique_samples))
names(sample_colors) <- unique_samples

# 创建注释颜色列表
ann_colors <- list(group = group_colors, 
                   sex = sex_colors,
                   Sample = sample_colors)

# 设置颜色断点
bk = unique(c(seq(-5,5, length=100)))
lancet_colors <- colorRampPalette(c("#00468B", "white", "#ED0000"))(100)

# ========== pheatmap版本 1: 完整注释 ==========
p1 <- pheatmap(log2(data_48+1),
               breaks = bk,
               annotation_col = Type_regulon[, c("group", "sex", "Sample")],  # 包含Sample列
               annotation_colors = ann_colors,
               color = lancet_colors,
               cluster_cols = FALSE,  # 不聚类列，保持排序
               cluster_rows = FALSE,  # 不聚类行，保持原始顺序
               scale = "row",
               show_colnames = TRUE,
               fontsize = 8,
               fontsize_row = 12,
               #fontsize_col = 12,
               angle_col = 90,  # 修改为pheatmap接受的值
               gaps_col = gaps_positions,
               main = "Regulon Expression Heatmap (Complete Annotation)")

# 保存热图
ggsave(file.path(output_1,'pheatmap_v1_gsva_48samples_27regulons.pdf'), p1, width = 12, height =10)

# ========== pheatmap版本 2: 简化注释 ==========
ann_colors_simple <- list(group = group_colors, 
                          sex = sex_colors)

p2 <- pheatmap(log2(data_48+1),
               breaks = bk,
               annotation_col = Type_regulon[, c("group", "sex")],  # 只包含group和sex列
               annotation_colors = ann_colors_simple,
               color = lancet_colors,
               cluster_cols = FALSE,  # 不聚类列，保持排序
               cluster_rows = FALSE,  # 不聚类行，保持原始顺序
               scale = "row",
               show_colnames = TRUE,
               fontsize = 8,
               fontsize_row = 10,
               #fontsize_col = 12,
               angle_col = 90,  # 修改为pheatmap接受的值
               gaps_col = gaps_positions,
               main = "Regulon Expression Heatmap (Group & Sex)")

# 保存简化版热图
ggsave(file.path(output_1,'pheatmap_v2_gsva_48samples_27regulons.pdf'), p2, width = 10, height = 5)

# ========== ggplot2分面热图 ==========
# 准备ggplot数据
data_48_scaled <- t(scale(t(log2(data_48+1))))  # 行标准化
data_long <- melt(data_48_scaled)
colnames(data_long) <- c("Regulon", "Sample", "Expression")

# 添加分组信息
data_long$Group <- Type_regulon[data_long$Sample, "group"]
data_long$Sex <- Type_regulon[data_long$Sample, "sex"]

# 确保因子顺序 - 与pheatmap保持一致
data_long$Group <- factor(data_long$Group, levels = group_order)
data_long$Regulon <- factor(data_long$Regulon, levels = regulon_order)  # 使用regulon_order
data_long$Sample <- factor(data_long$Sample, levels = rownames(Type_regulon))

# ========== 分面热图 - 配色与pheatmap保持一致 ==========
p3 <- ggplot(data_long, aes(x = Sample, y = Regulon, fill = Expression)) +
  geom_tile(color = "white", size = 0.1) +
  scale_fill_gradient2(low = "#00468B", mid = "white", high = "#ED0000", 
                       midpoint = 0, name = "Expression\n(Z-score)") +  # 与pheatmap保持一致的配色
  facet_grid(. ~ Group, scales = "free_x", space = "free_x") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 7),
    axis.text.y = element_text(size = 10),
    axis.title = element_text(size = 12),
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 9),
    panel.grid = element_blank(),
    plot.title = element_text(size = 14, hjust = 0.5),
    strip.text = element_text(size = 10, face = "bold"),
    strip.background = element_rect(fill = "lightgray"),
    legend.position = "right"
  ) +
  labs(title = "Regulon Expression by Group (Faceted Heatmap)",
       x = "Samples", y = "Regulons")

# 保存ggplot分面版本热图
ggsave(file.path(output_1,'ggplot_faceted_heatmap_v3_gsva_48samples_27regulons.pdf'), p3, 
       width = 11, height = 5, dpi = 300)
```









